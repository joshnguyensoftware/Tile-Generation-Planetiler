# Tile Generation Planetiler

A complete tile generation and visualization pipeline for displaying geospatial data (Geofences, Trips, Stops).

## Architecture

1. **Data Generation** - TypeScript script generates synthetic GeoJSON data
2. **Tile Generation** - Java/Planetiler converts GeoJSON to vector tiles (PBF)
3. **Frontend** - React + MapLibre GL visualizes the tiles

---

## 1: Data Generation

A TypeScript script to generate features of synthetic GeoJSON data (Geofences, Trips, Stops) within New Zealand.

The current distribution ratio is 40% Geofences, 40% Trips and 20% Stops.

### Usage

1. **Install**
```bash
cd dataGeneration && npm install
```

2. **Run**
```bash
npx tsx main.ts
```

3. **Test**
```bash
npm test
```

### Configuration
Adjust `TOTAL_FEATURES` and distribution ratios in `dataGeneration/constants.ts`.

### Output
The script generates a file named `sampleData.geojson` at `dataGeneration/data/sampleData.geojson`.

---

## 2: Tile Generation (Planetiler)

A Java application using Planetiler to convert GeoJSON into vector tiles (PBF format).

### Prerequisites
- Java 17+
- Maven 3.6+

### Setup

1. **Navigate to planetiler folder**
```bash
cd planetiler
```

2. **Build the JAR**
```bash
mvn clean package
```

### Usage

1. **Generate Tiles (Uncompressed - Currently being used for Development)**
```bash
java -jar target/planetiler-1.0-SNAPSHOT.jar --force --tile-compression=none
```

### Configuration

- **Input:** `planetiler/data/sampleData.geojson` (generated by Data Generation script)
- **Output:** `planetiler/outputTiles/` (vector tiles organized by z/x/y.pbf)
- **Profile:** `src/main/java/com/eroad/NzProfile.java` (defines layers and attributes)
- **Processors:** `src/main/java/com/eroad/processors/` (GeofenceProcessor, TripProcessor, StopProcessor)

### Layers Generated

| Layer       | Type    | Attributes                | Zoom Levels |
|-------------|---------|---------------------------|-------------|
| geofences   | Polygon | id                        | 0-14        |
| trips       | Line    | id, vehicle               | 0-14        |
| stops       | Point   | id, duration_mins         | 0-14        |

### Testing

```bash
mvn test
```

Tests are located in `src/test/java/com/eroad/`.

### Serving Tiles Locally

Use `http-server` to serve the generated tiles:

```bash
npx http-server outputTiles --cors -p 8080
```

---

## 3: Frontend (React + MapLibre GL)

A React TypeScript application that visualizes the generated vector tiles using MapLibre GL.

### Prerequisites
- Node.js 18+
- npm or yarn

### Setup

1. **Navigate to frontend folder**
```bash
cd frontend/react-ts
```

2. **Install dependencies**
```bash
npm install
```

3. **Configure Map**
Update `src/config/mapConfig.ts` if needed:
- `initialCenter`: Map center coordinates [lng, lat]
- `initialZoom`: Initial zoom level
- `sources.PLANETILER.url`: Tile server URL

### Usage

1. **Start Development Server**
```bash
npm run dev
```

2. **Build for Production**
```bash
npm run build
```

3. **Preview Production Build**
```bash
npm run preview
```

### Project Structure

```
frontend/react-ts/src/
├── components/          # React components
│   └── map.tsx         # Main map component
├── config/             # Configuration files
│   ├── mapConfig.ts    # Map settings (center, zoom, sources)
│   └── mapStyles.ts    # Layer definitions and styling
├── hooks/              # Custom React hooks
│   └── useMap.ts       # Map initialization logic
├── App.tsx             # Root component
└── main.tsx            # Entry point
```

### Map Layers

The frontend displays three layers from the vector tiles:

- **Geofences** - Red filled polygons with 50% opacity
- **Trips** - Blue lines (2px width)
- **Stops** - Green circles (4px radius)

### Customization

**To change layer styles**, edit `src/config/mapStyles.ts`:

```typescript
export const MAP_LAYERS: LayerSpecification[] = [
  {
    id: 'geofences-layer',
    type: 'fill',
    'source-layer': 'geofences',
    paint: {
      'fill-color': '#ff0000',  // Change color
      'fill-opacity': 0.5        // Change opacity
    }
  },
  // ...
];
```

**To change map center/zoom**, edit `src/config/mapConfig.ts`:

```typescript
export const MAP_CONFIG = {
  initialCenter: [174.7633, -36.8485] as [number, number], // Auckland
  initialZoom: 10,
  // ...
};
```

---

## Full Pipeline Workflow

1. **Generate Data**
```bash
cd dataGeneration
npx tsx main.ts
# Creates dataGeneration/data/sampleData.geojson
```
2. **Generate Tiles**
```bash
cd planetiler
java -jar target/planetiler-1.0-SNAPSHOT.jar --force --tile-compression=none
# Creates tiles in planetiler/outputTiles/
```

3. **Serve Tiles**
```bash
cd planetiler
npx http-server outputTiles --cors -p 8080
```

4. **Start Frontend**
```bash
cd frontend/react-ts
npm run dev
# Open browser to http://localhost:5173
```

---

## Troubleshooting

### No Data Visible on Map

1. **Check tile server is running**: Visit `http://localhost:8080/metadata.json`
2. **Check CORS**: Ensure `http-server` started with `--cors` flag
3. **Check layer names**: Verify `source-layer` in `mapStyles.ts` matches layers in `metadata.json`
4. **Check zoom level**: Data is only visible at zoom levels 0-14

### 404 Errors in Browser Console

This is normal for sparse data. Tiles are only generated where features exist.

